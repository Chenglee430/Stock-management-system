<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>股票工具 Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 開發便利用 CDN（生產環境建議改本地編譯） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{color-scheme: light dark}
    body{background:#0b1220;color:#e6edf3}
    .mask{background:rgba(0,0,0,.55)}
    .hide{display:none!important;visibility:hidden!important;opacity:0!important;pointer-events:none!important}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px}
    .btn{padding:.5rem .75rem;border-radius:.5rem;background:#1f2937}
    .btn:hover{background:#334155}
  </style>
</head>
<body>
  <!-- 頂部列 -->
  <header class="px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="w-6 h-6 rounded bg-indigo-400"></div>
      <div class="font-semibold">股票工具 Pro</div>
    </div>
    <div class="flex items-center gap-3">
      <span id="loginUser" class="text-sm opacity-80"></span>
      <button id="btnLoginOpen" class="btn">登入</button>
      <button id="btnLogout" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 hide">登出</button>
    </div>
  </header>

  <main class="px-6 pb-24 max-w-6xl mx-auto">
    <!-- 搜尋與操作列 -->
    <div class="flex items-center gap-3">
      <input id="symInput" class="flex-1 px-4 py-2 rounded bg-slate-900 border border-slate-700 outline-none"
             placeholder="輸入代號，例如：TSLA 或 2330" />
      <div class="flex flex-wrap gap-2">
        <button id="btnQuote"  class="btn">即時報價</button>
        <button id="btnInfo"   class="btn">公司基本資料</button>
        <button id="btnUpdate" class="btn">更新到最新日K</button>
        <button id="btnPredict" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">預測</button>
        <button id="btnTarget"  class="px-3 py-2 rounded bg-sky-600 hover:bg-sky-500">目標價</button>
        <button id="btnSignal"  class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500">操作建議</button>
        <button id="btnRisk"    class="px-3 py-2 rounded bg-amber-600 hover:bg-amber-500">風險評估</button>
      </div>
    </div>

    <!-- 三欄資訊 -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <!-- 報價 -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">即時報價</h3>
        <div id="quoteBox" class="text-sm leading-7 opacity-90">
          最新價：—　漲跌幅：—　成交量：— <br/>
          昨收：—　開盤：—　最高：—　最低：—<br/>
          提示：<span id="quoteMsg" class="text-rose-400">尚未查詢</span>
        </div>
      </div>
      <!-- 公司資訊 -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">公司基本資料</h3>
        <div id="infoBox" class="text-sm leading-7 opacity-90">
          名稱：—　產業：—<br/>
          市值：—　PE：—　股利：— / —<br/>
          提示：<span id="infoMsg" class="text-rose-400">尚未查詢</span>
        </div>
      </div>
      <!-- 預測/信號/風險（固定欄位） -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">預測結果</h3>
        <div id="predBox" class="text-sm leading-7 opacity-90 space-y-2">
          <div><b>方法</b>：<span id="pred_method">—</span>　<b>明日預測</b>：<span id="pred_next">—</span></div>
          <div><b>建議</b>：<span id="pred_suggest">—</span>　<b>理由</b>：<span id="pred_reason">—</span></div>
          <div><b>目標價</b>：<span id="pred_target">—</span>　<b>信心</b>：<span id="pred_target_conf">—</span></div>
          <div><b>（近日操作）建議</b>：<span id="signal_advice">—</span>　
               <b>理由</b>：<span id="signal_why">—</span>　
               <b>有效期</b>：<span id="signal_days">—</span> 天</div>
          <div><b>（風險）VaR95%</b>：<span id="risk_var95">—</span>　
               <b>ATR</b>：<span id="risk_atr">—</span>　
               <b>Kelly cap20%</b>：<span id="risk_kelly20">—</span></div>
          <div>提示：<span id="predMsg" class="text-rose-400">尚未查詢</span></div>
        </div>
      </div>
    </section>

    <!-- K 線 -->
    <section class="card p-5 mt-6">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">K 線</h3>
        <div class="text-xs opacity-70">若無歷史資料，請先按「更新到最新日K」。</div>
      </div>
      <div id="kchart" class="mt-4" style="height:420px;"></div>
    </section>
  </main>

  <!-- 登入視窗 -->
  <div id="loginMask" class="fixed inset-0 mask flex items-center justify-center hide">
    <div class="bg-slate-950 border border-slate-700 rounded-xl p-6 w-[360px]">
      <h3 class="font-semibold mb-4">登入</h3>
      <div class="space-y-3">
        <input id="lgUser" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="帳號（建議 Email）">
        <input id="lgPass" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="密碼（6 位數字）">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnLogin" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">登入</button>
        <div class="flex items-center gap-3">
          <button id="btnRegister" class="text-sm opacity-80 hover:opacity-100">註冊</button>
          <button id="btnForgot"   class="text-sm opacity-80 hover:opacity-100">忘記密碼</button>
          <button id="btnCloseLogin" class="text-sm opacity-80 hover:opacity-100">關閉</button>
        </div>
      </div>
      <div id="lgMsg" class="mt-3 text-sm text-rose-400"></div>
    </div>
  </div>

  <!-- 重設密碼 -->
  <div id="fpMask" class="fixed inset-0 mask flex items-center justify-center hide">
    <div class="bg-slate-950 border border-slate-700 rounded-xl p-6 w-[360px]">
      <h3 class="font-semibold mb-4">重設密碼</h3>
      <div class="space-y-3">
        <input id="fpEmail" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="帳號（與註冊相同）">
        <div class="flex gap-2">
          <input id="fpCode" class="flex-1 px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="4 碼驗證碼">
          <button id="btnSendCode" class="btn">取得驗證碼</button>
        </div>
        <input id="fpNew" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="新密碼（6 位數字）">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnResetPwd" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500">確認重設</button>
        <button id="btnFPClose" class="text-sm opacity-80 hover:opacity-100">返回登入</button>
      </div>
      <div id="fpMsg" class="mt-3 text-sm text-rose-400"></div>
    </div>
  </div>

  <!-- 主腳本：完整 -->
  <script>
  /* ===== 共用工具 ===== */
  const $ = (s)=>document.querySelector(s);
  const show = (el, on=true)=> el?.classList[on?'remove':'add']('hide');
  const setTxt = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v ?? '—'); };
  const busy   = (id,on)=>{ const el=document.getElementById(id); if(el) el.disabled = !!on; };
  const toast  = (m)=> setTxt('predMsg', m||'');
  const num = v => (v==null || isNaN(v)) ? null : Number(v);
  /* ===== 代號正規化 ===== */
  function getSymbolRaw(){ return ($('#symInput')?.value||'').trim(); }
  function normalizeSymbol(raw){
    let s = (raw||'').trim().toUpperCase();
    if(!s) return '';
    if(/^\d{4}(\.TW|\.TWO)?$/.test(s)){ if(!/\.TW|\.TWO$/.test(s)) s += '.TW'; return s; }
    return s.replace('.', '-');
  }
  function mustSymbol(){
    const s = normalizeSymbol(getSymbolRaw());
    if(!s) throw new Error('請先輸入代號，如 TSLA 或 2330');
    return s;
  }

  /* ===== 後端呼叫 ===== */
  async function callAPI(action, payload={}){
    const fd = new FormData();
    fd.append('action', action);
    for(const [k,v] of Object.entries(payload)) fd.append(k, v);
    const r = await fetch('api.php', {method:'POST', body:fd});
    return r.json().catch(()=>({ok:false,error:'bad_json'}));
  }
  async function callAuth(action, payload={}){
    const fd = new FormData();
    fd.append('action', action);
    for(const [k,v] of Object.entries(payload)) fd.append(k, v);
    const r = await fetch('auth.php', {method:'POST', body:fd});
    return r.json().catch(()=>({ok:false,error:'bad_json'}));
  }

  /* ===== 報價 / 公司 ===== */
  function uiShowQuoteError(msg){ setTxt('quoteMsg', msg||'error'); }
  function uiShowInfoError(msg){  setTxt('infoMsg',  msg||'error'); }
  function uiShowPredError(msg){  setTxt('predMsg',  msg||'error'); }

  function renderQuote(d){
  setTxt('quoteMsg','');
  // 自算漲跌幅（server 沒算就前端算）
  if ((d.changePct === null || d.changePct === undefined) && d.last != null && d.prevClose != null && d.prevClose !== 0){
    d.changePct = Math.round(((d.last - d.prevClose) / d.prevClose) * 10000) / 100;
  }
  const box = $('#quoteBox'); if(!box) return;
  box.innerHTML =
    `最新價：${d.last??'—'}　漲跌幅：${d.changePct??'—'}　成交量：${d.volume??'—'}<br/>
     昨收：${d.prevClose??'—'}　開盤：${d.open??'—'}　最高：${d.high??'—'}　最低：${d.low??'—'}`;
  if(d.ohlc && d.ohlc.length){
    const x=d.ohlc.map(o=>o.date), o=d.ohlc.map(o=>o.open), h=d.ohlc.map(o=>o.high), l=d.ohlc.map(o=>o.low), c=d.ohlc.map(o=>o.close);
    Plotly.newPlot('kchart', [{x,open:o,high:h,low:l,close:c,type:'candlestick'}],
                   {margin:{t:20,r:10,l:40,b:30}}, {displayModeBar:false});
  }
}

  function renderInfo(d){
    setTxt('infoMsg','');
    const box = $('#infoBox'); if(!box) return;
    box.innerHTML =
      `名稱：${d.company_name||'—'}　產業：${d.industry||'—'}<br/>
       市值：${d.market_cap||'—'}　PE：${d.pe||'—'}　股利：${d.dividend_per_share||'—'} / ${d.dividend_yield||'—'}`;
  }

  /* ===== K 線 ===== */
  async function drawHistory(sym){
    const j = await callAPI('history',{symbol:sym});
    if(!j.ok || !j.data || !j.data.ohlc || !j.data.ohlc.length){
      toast('查無歷史資料，請先按「更新到最新日K」'); return;
    }
    const arr = j.data.ohlc;
    const x = arr.map(o=>o.date);
    const o = arr.map(o=>o.open), h=arr.map(o=>o.high), l=arr.map(o=>o.low), c=arr.map(o=>o.close);
    Plotly.newPlot('kchart',
      [{x,open:o,high:h,low:l,close:c,type:'candlestick'}],
      {margin:{t:20,r:10,l:40,b:30}}, {displayModeBar:false});
  }

  /* ===== 預測區（固定欄位） ===== */
  function clearPredictArea(){
    setTxt('pred_method','—'); setTxt('pred_next','—');
    setTxt('pred_suggest','—'); setTxt('pred_reason','—');
    setTxt('pred_target','—'); setTxt('pred_target_conf','—');
    setTxt('signal_advice','—'); setTxt('signal_why','—'); setTxt('signal_days','—');
    setTxt('risk_var95','—'); setTxt('risk_atr','—'); setTxt('risk_kelly20','—');
    toast('');
  }
  function renderPredict(d){
    const method = d?.method || d?.algo || '—';
    const pred   = num(d?.next_close_pred);
    const last   = num(d?.last_close);
    const parts  = d?.components && typeof d.components==='object' ? d.components : null;

    // —— 建議：用預測與昨收的相對變化自動判斷（閾值可調）
    let advice = '—';
    let reason = 'RF/LR/Ridge 混合';
    if (pred!=null && last!=null && last!==0){
    const chg = (pred - last) / last;          // 相對漲跌
    const up = 0.008, dn = -0.008;             // 0.8% 閾值（你想更保守可改 1%）
    advice = chg > up ? '偏多' : (chg < dn ? '偏空' : '觀望');
    reason = `預測相對昨收 ${ (chg*100).toFixed(2) }%；${reason}`;
  }
    let confTxt = '—';
  if (parts){
    const vals = Object.values(parts).map(num).filter(v=>v!=null);
    if (vals.length >= 2 && pred!=null){
      const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
      const variance = vals.reduce((a,b)=>a+(b-mean)**2,0)/vals.length;
      const std = Math.sqrt(variance);
      // 將「分散 / 價格」映射到 0–100 分，數學係數可按口味微調
      const cv = std / Math.max(1, Math.abs(pred));   // 變異係數
      let conf = Math.max(0, 100 - Math.min(100, cv * 4000)); // 4000 是縮放係數
      confTxt = `${conf.toFixed(0)}%`;
    }
  }

  // —— 寫入畫面
  setTxt('pred_method', method);
  setTxt('pred_next',   pred!=null ? pred : '—');
  setTxt('pred_suggest', advice);
  setTxt('pred_reason',  reason);
  // 「信心」屬於目標價那一列，這裡不動；若你想把這個信心也顯示在目標價那行，可在 renderTarget 內備援套用。
  toast('');
}
function renderTarget(d){
  // 後端可能回這些鍵名
  const tech = num(d?.tech_target);
  const val  = num(d?.val_target);
  const sug  = num(d?.suggested_target);
  const last = num(d?.last_close);
  // —— 顯示的目標價：優先 suggested，其次 tech，再 val
  const target = (sug??tech??val);
  setTxt('pred_target', target!=null ? target : '—');

  // —— 信心：用「技術面 vs 估值面」的一致性估計（差距越小越有信心）
  // 若 tech/val 兩者皆有，用 |tech - val| 與基準（取 last 或 target）比；否則用「target 與 last」距離粗估。
  let confTxt = '—';
  if (tech!=null && val!=null){
    const base = (last!=null && last>0) ? last : Math.max(1, Math.abs(target||0));
    const gap  = Math.abs(tech - val) / base;                 // 差距占比
    let conf = Math.max(0, 100 - Math.min(100, gap * 120));   // 120 為縮放係數，可調
    confTxt = `${conf.toFixed(0)}%`;
  } else if (target!=null && last!=null && last>0){
    // 只有一個面：距離越小，信心越保守
    const dist = Math.abs(target - last) / last;
    let conf = Math.max(0, 100 - Math.min(100, dist * 200));  // 200 為縮放係數，可調
    confTxt = `${conf.toFixed(0)}%`;
  }

  setTxt('pred_target_conf', confTxt);
  toast('');
}
  function renderSignal(d){
  // trade_signal.py：bias / setup / summary / timeframe_days :contentReference[oaicite:5]{index=5}
    const advice = [d?.bias, d?.setup].filter(Boolean).join(' / ');
    setTxt('signal_advice', advice || '—');
    setTxt('signal_why',    d?.summary ?? (d?.reasons?.join('；') || '—'));
    setTxt('signal_days',   d?.timeframe_days ?? '—');
    toast('');
  }
  function renderRisk(d){
  // risk_engine.py：risk.var95_daily（報酬率，顯示%）、risk.atr14、plan.kelly_fraction_cap20pct :contentReference[oaicite:6]{index=6}
    const varDaily = d?.risk?.var95_daily;
    setTxt('risk_var95',  (varDaily!=null) ? (Math.round(varDaily*10000)/100 + '%') : '—');
    setTxt('risk_atr',    d?.risk?.atr14 ?? '—');
    const kelly = d?.plan?.kelly_fraction_cap20pct;
    setTxt('risk_kelly20', (kelly!=null) ? (Math.round(kelly*1000)/10 + '%') : '—');
    toast('');
  }

  /* ===== 按鈕事件 ===== */
  document.getElementById('btnQuote')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('quote_live', {symbol:sym});
      if(!j.ok) return uiShowQuoteError(j.error);
      renderQuote(j.data);
      if(!j.data?.ohlc?.length){ await drawHistory(sym); }
    }catch(e){ uiShowQuoteError(e.message); }
  });
  document.getElementById('btnInfo')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('info', {symbol:sym});
      if(!j.ok) return uiShowInfoError(j.error);
      renderInfo(j.data);
    }catch(e){ uiShowInfoError(e.message); }
  });
  document.getElementById('btnUpdate')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('update_today', {symbol:sym});
      if(!j.ok) return uiShowPredError(j.error);
      await drawHistory(sym);
      toast('已回填並更新 K 線');
    }catch(e){ uiShowPredError(e.message); }
  });
  async function doPredict(){
    const sym = mustSymbol();
    busy('btnPredict',true); toast('計算中…');
    const j = await callAPI('predict_next', {symbol:sym});
    busy('btnPredict',false);
    if(!j.ok){ toast(j.error||'predict_failed'); return; }
    renderPredict(j.data);
  }
  async function doTarget(){
    const sym = mustSymbol();
    busy('btnTarget', true); toast('計算中…');
    const j = await callAPI('predict_target', {symbol:sym, horizon:40});
    busy('btnTarget', false);
    if(!j.ok){ toast(j.error||'predict_target_failed'); return; }
    renderTarget(j.data);
  }
  async function doSignal(){
    const sym = mustSymbol();
    busy('btnSignal', true); toast('分析中…');
    const j = await callAPI('signal', {symbol:sym});
    busy('btnSignal', false);
    if(!j.ok){ toast(j.error||'signal_failed'); return; }
    renderSignal(j.data);
  }

  async function doRisk(){
    const sym = mustSymbol();
    busy('btnRisk', true); toast('分析中…');
    const j = await callAPI('risk', {symbol:sym, horizon:20});
    busy('btnRisk', false);
    if(!j.ok){ toast(j.error||'predict_risk_failed'); return; }
    renderRisk(j.data);
  }
  document.getElementById('btnPredict')?.addEventListener('click', doPredict);
  document.getElementById('btnTarget') ?.addEventListener('click', doTarget);
  document.getElementById('btnSignal') ?.addEventListener('click', doSignal);
  document.getElementById('btnRisk')   ?.addEventListener('click', doRisk);

  /* ===== 登入 / 註冊 / 重設 ===== */
  function updateLoginUI(user){
    if(user){
      $('#loginUser').textContent = user.username;
      show($('#btnLogout'), true); show($('#btnLoginOpen'), false); show($('#loginMask'), false);
    }else{
      $('#loginUser').textContent = '';
      show($('#btnLogout'), false); show($('#btnLoginOpen'), true);
    }
  }
  $('#btnLoginOpen')?.addEventListener('click', ()=> show($('#loginMask'), true));
  $('#btnCloseLogin')?.addEventListener('click', ()=> show($('#loginMask'), false));
  $('#btnLogout')?.addEventListener('click', async()=>{ await fetch('auth.php?action=logout'); updateLoginUI(null); });

  $('#btnLogin')?.addEventListener('click', async()=>{
    const u=$('#lgUser').value.trim(), p=$('#lgPass').value.trim();
    const j = await callAuth('login',{username:u,password:p});
    if(!j.ok){ setTxt('lgMsg', j.error||'login_failed'); return; }
    setTxt('lgMsg',''); updateLoginUI(j.user);
  });
  $('#btnRegister')?.addEventListener('click', async()=>{
    const u=$('#lgUser').value.trim(), p=$('#lgPass').value.trim();
    const j = await callAuth('register',{username:u,password:p});
    setTxt('lgMsg', j.ok ? '註冊成功，請按登入' : (j.error||'register_failed'));
  });
  $('#btnForgot')?.addEventListener('click', ()=>{
    $('#fpEmail').value = $('#lgUser').value.trim(); $('#fpCode').value=''; $('#fpNew').value='';
    setTxt('fpMsg',''); show($('#fpMask'), true); show($('#loginMask'), false);
  });
  $('#btnFPClose')?.addEventListener('click', ()=>{ show($('#fpMask'), false); show($('#loginMask'), true); });
  $('#btnSendCode')?.addEventListener('click', async()=>{
    const email=$('#fpEmail').value.trim();
    const j = await callAuth('forgot_password',{email});
    setTxt('fpMsg', j.ok ? `驗證碼（測試用）：${j.code}` : (j.error||'failed'));
  });
  $('#btnResetPwd')?.addEventListener('click', async()=>{
    const email=$('#fpEmail').value.trim(), code=$('#fpCode').value.trim(), newp=$('#fpNew').value.trim();
    const j = await callAuth('reset_password',{email,code,new_password:newp});
    setTxt('fpMsg', j.ok ? '已重設，請回登入' : (j.error||'failed'));
  });

  /* ===== 開站自檢 ===== */
  (async()=>{
    try{
      const w = await fetch('auth.php?action=whoami').then(r=>r.json());
      updateLoginUI(w?.user||null);
      await fetch('api.php?action=diag').then(r=>r.json());
    }catch{}
  })();
  </script>
</body>
</html>
