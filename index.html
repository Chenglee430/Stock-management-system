<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>股票工具 Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 開發便利用 CDN（生產環境建議改本地編譯） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{color-scheme: light dark}
    body{background:#0b1220;color:#e6edf3}
    .mask{background:rgba(0,0,0,.55)}
    .hide{display:none!important;visibility:hidden!important;opacity:0!important;pointer-events:none!important}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px}
    .btn{padding:.5rem .75rem;border-radius:.5rem;background:#1f2937}
    .btn:hover{background:#334155}
  </style>
</head>
<body>
  <!-- 頂部列 -->
  <header class="px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="w-6 h-6 rounded bg-indigo-400"></div>
      <div class="font-semibold">股票工具 Pro</div>
    </div>
    <div class="flex items-center gap-3">
      <span id="loginUser" class="text-sm opacity-80"></span>
      <button id="btnLoginOpen" class="btn">登入</button>
      <button id="btnLogout" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500 hide">登出</button>
    </div>
  </header>

  <main class="px-6 pb-24 max-w-6xl mx-auto">
    <!-- 搜尋與操作列 -->
    <div class="flex items-center gap-3">
      <input id="symInput" class="flex-1 px-4 py-2 rounded bg-slate-900 border border-slate-700 outline-none"
             placeholder="輸入代號，例如：TSLA 或 2330" />
      <div class="flex flex-wrap gap-2">
        <button id="btnQuote"  class="btn">即時報價</button>
        <button id="btnInfo"   class="btn">公司基本資料</button>
        <button id="btnUpdate" class="btn">更新到最新日K</button>
        <button id="btnPredict" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">預測</button>
        <button id="btnTarget"  class="px-3 py-2 rounded bg-sky-600 hover:bg-sky-500">目標價</button>
        <button id="btnSignal"  class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500">操作建議</button>
        <button id="btnRisk"    class="px-3 py-2 rounded bg-amber-600 hover:bg-amber-500">風險評估</button>
      </div>
    </div>

    <!-- 三欄資訊 -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <!-- 報價 -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">即時報價</h3>
        <div id="quoteBox" class="text-sm leading-7 opacity-90">
          最新價：—　漲跌幅：—　成交量：— <br/>
          昨收：—　開盤：—　最高：—　最低：—<br/>
          提示：<span id="quoteMsg" class="text-rose-400">尚未查詢</span>
        </div>
      </div>
      <!-- 公司資訊 -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">公司基本資料</h3>
        <div id="infoBox" class="text-sm leading-7 opacity-90">
          名稱：—　產業：—<br/>
          市值：—　PE：—　股利：— / —<br/>
          提示：<span id="infoMsg" class="text-rose-400">尚未查詢</span>
        </div>
      </div>
      <!-- 預測/信號/風險（固定欄位） -->
      <div class="card p-5">
        <h3 class="font-semibold mb-3">預測結果</h3>
        <div id="predBox" class="text-sm leading-7 opacity-90 space-y-2">
          <div><b>方法</b>：<span id="pred_method">—</span>　<b>明日預測</b>：<span id="pred_next">—</span></div>
          <div><b>建議</b>：<span id="pred_suggest">—</span>　<b>理由</b>：<span id="pred_reason">—</span></div>
          <div><b>目標價</b>：<span id="pred_target">—</span>　<b>信心</b>：<span id="pred_target_conf">—</span></div>
          <div><b>（近日操作）建議</b>：<span id="signal_advice">—</span>　
               <b>理由</b>：<span id="signal_why">—</span>　
               <b>有效期</b>：<span id="signal_days">—</span> 天</div>
          <div><b>（風險）VaR95%</b>：<span id="risk_var95">—</span>　
               <b>ATR</b>：<span id="risk_atr">—</span>　
               <b>Kelly cap20%</b>：<span id="risk_kelly20">—</span></div>
          <div>提示：<span id="predMsg" class="text-rose-400">尚未查詢</span></div>
        </div>
      </div>
    </section>

    <!-- K 線 -->
<section class="card p-5 mt-6">
  <div class="flex items-center justify-between gap-3 flex-wrap">
    <h3 class="font-semibold">K 線</h3>

    <!-- 右上控制列 -->
    <div class="flex items-center gap-2 text-xs">
      <!-- 顆粒度 -->
      <div class="flex items-center gap-1">
        <button class="btn" data-k-tf="D">日K</button>
        <button class="btn" data-k-tf="W">週K</button>
        <button class="btn" data-k-tf="M">月K</button>
      </div>

      <!-- 區間 -->
      <div class="flex items-center gap-1">
        <button class="btn" data-k-range="1M">1M</button>
        <button class="btn" data-k-range="3M">3M</button>
        <button class="btn" data-k-range="6M">6M</button>
        <button class="btn" data-k-range="1Y">1Y</button>
        <button class="btn" data-k-range="YTD">YTD</button>
        <button class="btn" data-k-range="ALL">ALL</button>
      </div>

      <!-- 指標 -->
      <div class="flex items-center gap-2 ml-2">
        <label class="flex items-center gap-1"><input type="checkbox" id="chkMA5"  checked>MA5</label>
        <label class="flex items-center gap-1"><input type="checkbox" id="chkMA20" checked>MA20</label>
        <label class="flex items-center gap-1"><input type="checkbox" id="chkMA60" >MA60</label>
        <label class="flex items-center gap-1"><input type="checkbox" id="chkBB"   >BB(20,2)</label>
        <label class="flex items-center gap-1"><input type="checkbox" id="chkRSI"  >RSI(14)</label>
        <label class="flex items-center gap-1"><input type="checkbox" id="chkMACD" >MACD</label>
      </div>

      <!-- 主題 -->
      <div class="flex items-center gap-1 ml-2">
        <button id="btnTheme" class="btn">深 / 淺</button>
      </div>
    </div>
  </div>

  <!-- 圖表 -->
  <div id="kchart" class="mt-3" style="height:820px;"></div>
</section>


  <!-- 登入視窗 -->
  <div id="loginMask" class="fixed inset-0 mask flex items-center justify-center hide">
    <div class="bg-slate-950 border border-slate-700 rounded-xl p-6 w-[360px]">
      <h3 class="font-semibold mb-4">登入</h3>
      <div class="space-y-3">
        <input id="lgUser" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="帳號（建議 Email）">
        <input id="lgPass" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="密碼（6 位數字）">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnLogin" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">登入</button>
        <div class="flex items-center gap-3">
          <button id="btnRegister" class="text-sm opacity-80 hover:opacity-100">註冊</button>
          <button id="btnForgot"   class="text-sm opacity-80 hover:opacity-100">忘記密碼</button>
          <button id="btnCloseLogin" class="text-sm opacity-80 hover:opacity-100">關閉</button>
        </div>
      </div>
      <div id="lgMsg" class="mt-3 text-sm text-rose-400"></div>
    </div>
  </div>

  <!-- 重設密碼 -->
  <div id="fpMask" class="fixed inset-0 mask flex items-center justify-center hide">
    <div class="bg-slate-950 border border-slate-700 rounded-xl p-6 w-[360px]">
      <h3 class="font-semibold mb-4">重設密碼</h3>
      <div class="space-y-3">
        <input id="fpEmail" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="帳號（與註冊相同）">
        <div class="flex gap-2">
          <input id="fpCode" class="flex-1 px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="4 碼驗證碼">
          <button id="btnSendCode" class="btn">取得驗證碼</button>
        </div>
        <input id="fpNew" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" placeholder="新密碼（6 位數字）">
      </div>
      <div class="flex items-center justify-between mt-4">
        <button id="btnResetPwd" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500">確認重設</button>
        <button id="btnFPClose" class="text-sm opacity-80 hover:opacity-100">返回登入</button>
      </div>
      <div id="fpMsg" class="mt-3 text-sm text-rose-400"></div>
    </div>
  </div>

  <!-- 主腳本：完整 -->
  <script>
  /* ===== 共用工具 ===== */
  const $ = (s)=>document.querySelector(s);
  const show = (el, on=true)=> el?.classList[on?'remove':'add']('hide');
  const setTxt = (id, v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v ?? '—'); };
  const busy   = (id,on)=>{ const el=document.getElementById(id); if(el) el.disabled = !!on; };
  const toast  = (m)=> setTxt('predMsg', m||'');
  const num = v => (v==null || isNaN(v)) ? null : Number(v);
  /* ===== 代號正規化 ===== */
  function getSymbolRaw(){ return ($('#symInput')?.value||'').trim(); }
  function normalizeSymbol(raw){
    let s = (raw||'').trim().toUpperCase();
    if(!s) return '';
    if(/^\d{4}(\.TW|\.TWO)?$/.test(s)){ if(!/\.TW|\.TWO$/.test(s)) s += '.TW'; return s; }
    return s.replace('.', '-');
  }
  function mustSymbol(){
    const s = normalizeSymbol(getSymbolRaw());
    if(!s) throw new Error('請先輸入代號，如 TSLA 或 2330');
    return s;
  }

  /* ===== 後端呼叫 ===== */
  async function callAPI(action, payload={}){
    const fd = new FormData();
    fd.append('action', action);
    for(const [k,v] of Object.entries(payload)) fd.append(k, v);
    const r = await fetch('api.php', {method:'POST', body:fd});
    return r.json().catch(()=>({ok:false,error:'bad_json'}));
  }
  async function callAuth(action, payload={}){
    const fd = new FormData();
    fd.append('action', action);
    for(const [k,v] of Object.entries(payload)) fd.append(k, v);
    const r = await fetch('auth.php', {method:'POST', body:fd});
    return r.json().catch(()=>({ok:false,error:'bad_json'}));
  }

  /* ===== 報價 / 公司 ===== */
  function uiShowQuoteError(msg){ setTxt('quoteMsg', msg||'error'); }
  function uiShowInfoError(msg){  setTxt('infoMsg',  msg||'error'); }
  function uiShowPredError(msg){  setTxt('predMsg',  msg||'error'); }

  function renderQuote(d){
  setTxt('quoteMsg','');
  // 自算漲跌幅（server 沒算就前端算）
  if ((d.changePct === null || d.changePct === undefined) && d.last != null && d.prevClose != null && d.prevClose !== 0){
    d.changePct = Math.round(((d.last - d.prevClose) / d.prevClose) * 10000) / 100;
  }
  const box = $('#quoteBox'); if(!box) return;
  box.innerHTML =
    `最新價：${d.last??'—'}　漲跌幅：${d.changePct??'—'}　成交量：${d.volume??'—'}<br/>
     昨收：${d.prevClose??'—'}　開盤：${d.open??'—'}　最高：${d.high??'—'}　最低：${d.low??'—'}`;
  if(d.ohlc && d.ohlc.length){
    const x=d.ohlc.map(o=>o.date), o=d.ohlc.map(o=>o.open), h=d.ohlc.map(o=>o.high), l=d.ohlc.map(o=>o.low), c=d.ohlc.map(o=>o.close);
    Plotly.newPlot('kchart', [{x,open:o,high:h,low:l,close:c,type:'candlestick'}],
                   {margin:{t:20,r:10,l:40,b:30}}, {displayModeBar:false});
  }
}

  function renderInfo(d){
    setTxt('infoMsg','');
    const box = $('#infoBox'); if(!box) return;
    box.innerHTML =
      `名稱：${d.company_name||'—'}　產業：${d.industry||'—'}<br/>
       市值：${d.market_cap||'—'}　PE：${d.pe||'—'}　股利：${d.dividend_per_share||'—'} / ${d.dividend_yield||'—'}`;
  }

  /* ===== K 線 ===== */

/* ==================== K 線模組（Plotly + 指標 + 顆粒度 + 主題） ==================== */
/** 全域狀態 */
const KState = {
  theme: 'dark',            // 'dark' | 'light'
  tf: 'D',                  // 'D' | 'W' | 'M'
  range: 'ALL',             // '1M' '3M' '6M' '1Y' 'YTD' 'ALL'
  rawDaily: null,           // 後端回來的日資料 [{date, open, high, low, close, volume}]
  data: null,               // 目前顯示顆粒度資料
  traces: [],               // 現在的 traces
};

/** 顏色主題 */
const Themes = {
  dark: {
    paper:'#0b1220', plot:'#0b1220', fg:'#e6edf3', grid:'rgba(255,255,255,.08)', vol:'#5b8', ma5:'#8ab4f8', ma20:'#fbbc05', ma60:'#34d399', bb:'#a78bfa', rsi:'#60a5fa', macd:'#f87171'
  },
  light: {
    paper:'#ffffff', plot:'#ffffff', fg:'#111827', grid:'rgba(0,0,0,.12)', vol:'#0a7', ma5:'#1e40af', ma20:'#b45309', ma60:'#047857', bb:'#6d28d9', rsi:'#2563eb', macd:'#dc2626'
  }
};

/** 工具：日期區間裁切 */
function sliceByRange(arr, range){
  if(!arr || !arr.length) return [];
  if(range==='ALL') return arr.slice();
  const end = new Date(arr[arr.length-1].date + 'T00:00:00');
  let start = new Date(end);
  if(range==='1M') start.setMonth(start.getMonth()-1);
  else if(range==='3M') start.setMonth(start.getMonth()-3);
  else if(range==='6M') start.setMonth(start.getMonth()-6);
  else if(range==='1Y') start.setFullYear(start.getFullYear()-1);
  else if(range==='YTD') start = new Date(end.getFullYear(),0,1);
  return arr.filter(r=> new Date(r.date+'T00:00:00') >= start);
}

/** 工具：日→週/月 重新取樣（OHLCV） */
function resampleOHLC(daily, tf){
  if(tf==='D') return daily.slice();
  const out=[];
  let bucket=null, lastWeek=null, lastMonth=null;
  for(const r of daily){
    const d = new Date(r.date + 'T00:00:00');
    const w = d.getFullYear()+'-W'+String(getISOWeek(d)).padStart(2,'0');
    const m = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const key = tf==='W'? w : m;
    if((tf==='W' && key!==lastWeek) || (tf==='M' && key!==lastMonth)){
      if(bucket) out.push(bucket);
      bucket = {date:r.date, open:r.open, high:r.high, low:r.low, close:r.close, volume:(r.volume||0)};
      lastWeek = tf==='W'? key: lastWeek;
      lastMonth= tf==='M'? key: lastMonth;
    }else{
      bucket.high = Math.max(bucket.high, r.high);
      bucket.low  = Math.min(bucket.low,  r.low);
      bucket.close= r.close;
      bucket.volume = (bucket.volume||0) + (r.volume||0);
    }
  }
  if(bucket) out.push(bucket);
  return out;

  function getISOWeek(d){
    const tmp=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
    const day=tmp.getUTCDay()||7; tmp.setUTCDate(tmp.getUTCDate()+4-day);
    const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
    return Math.ceil((((tmp - yearStart)/86400000)+1)/7);
  }
}

/** 指標：移動平均 */
function MA(arr, period){
  const out = new Array(arr.length).fill(null);
  let sum=0;
  for(let i=0;i<arr.length;i++){
    const v = arr[i]; if(v!=null) sum += v;
    if(i>=period) { if(arr[i-period]!=null) sum -= arr[i-period]; }
    if(i>=period-1) out[i] = sum/period;
  }
  return out;
}
/** 指標：布林 */
function Bollinger(close, period=20, stdev=2){
  const outU=new Array(close.length).fill(null);
  const outM=MA(close, period);
  const outL=new Array(close.length).fill(null);
  for(let i=0;i<close.length;i++){
    if(i<period-1) continue;
    const seg = close.slice(i-period+1,i+1).filter(v=>v!=null);
    if(seg.length<period) continue;
    const m = outM[i];
    const variance = seg.reduce((a,b)=>a+(b-m)*(b-m),0)/period;
    const sd = Math.sqrt(variance);
    outU[i]=m+stdev*sd; outL[i]=m-stdev*sd;
  }
  return {upper:outU, mid:outM, lower:outL};
}
/** 指標：RSI(14) */
function RSI(close, period=14){
  const out=new Array(close.length).fill(null);
  let gain=0, loss=0;
  for(let i=1;i<close.length;i++){
    const chg=close[i]-close[i-1];
    const g=chg>0?chg:0, l=chg<0?(-chg):0;
    if(i<=period){ gain+=g; loss+=l; if(i===period){ const rs = loss===0?100:(gain/loss); out[i]=100-100/(1+rs);} }
    else{
      gain=(gain*(period-1)+g)/period; loss=(loss*(period-1)+l)/period;
      const rs = loss===0?100:(gain/loss); out[i]=100-100/(1+rs);
    }
  }
  return out;
}
/** 指標：MACD(12,26,9) */
function EMA(arr, p){
  const out=new Array(arr.length).fill(null); const k=2/(p+1);
  let ema=null;
  for(let i=0;i<arr.length;i++){
    const v=arr[i]; if(v==null){ out[i]=ema; continue; }
    ema = (ema==null)? v : (v*k + ema*(1-k));
    out[i]=ema;
  }
  return out;
}
function MACD(close, fast=12, slow=26, signal=9){
  const emaF=EMA(close, fast), emaS=EMA(close, slow);
  const macd = close.map((_,i)=> (emaF[i]!=null && emaS[i]!=null) ? (emaF[i]-emaS[i]) : null);
  const sig  = EMA(macd, signal);
  const hist = macd.map((v,i)=> (v!=null && sig[i]!=null) ? (v-sig[i]) : null);
  return {macd, signal:sig, hist};
}

/** 主題切換 */
function getLayoutTheme({showRSI, showMACD}){
  const t = Themes[KState.theme];

  // 依勾選自動分配比例（總和 <= 1）
  // 主圖至少 58%，最多 80%；Volume 固定 10–12%；剩下給 RSI/MACD
  let yMainTop = 1.00;         // 上界
  let yVolH   = 0.12;          // 量能高度
  let yMACDH  = showMACD ? 0.12 : 0;
  let yRSIH   = showRSI  ? 0.16 : 0;
  let used    = yVolH + yMACDH + yRSIH + 0.02; // 各區之間留 0.02 空白
  let yMainH  = Math.max(0.58, 1 - used);      // 主圖高度（至少 58%）

  // 座標軸 domain（由下而上排）
  const y0 = 0.00;                     // MACD 起點
  const yMACD0 = y0;
  const yMACD1 = yMACD0 + yMACDH;

  const yRSI0  = yMACD1 + (showMACD?0.02:0);
  const yRSI1  = yRSI0 + yRSIH;

  const yVol0  = yRSI1 + (showRSI?0.02:0);
  const yVol1  = yVol0 + yVolH;

  const yMain0 = yVol1 + 0.02;
  const yMain1 = yMain0 + yMainH;

  return {
    paper_bgcolor:t.paper,
    plot_bgcolor:t.plot,
    font:{color:t.fg},
    hovermode:'x unified',
    hoverlabel:{font:{size:12}},
    margin:{t:20,r:10,l:48,b:24},
    legend:{orientation:'h', y:1.02, x:0},
    xaxis:{gridcolor:t.grid, showspikes:true, spikemode:'across', spikesnap:'cursor', spikedash:'solid', spikethickness:1},

    // 主圖
    yaxis:{domain:[yMain0, yMain1], gridcolor:t.grid},

    // 量能
    yaxis2:{domain:[yVol0, yVol1], gridcolor:t.grid, title:'Vol', titlefont:{size:10}},

    // RSI（沒勾選時仍保留軸但高度0，避免 Plotly 重新建立圖時抖動）
    yaxis3:{domain:[yRSI0, yRSI1], gridcolor:t.grid, title:'RSI', titlefont:{size:10}, range:[0,100], showticklabels:showRSI},

    // MACD
    yaxis4:{domain:[yMACD0, yMACD1], gridcolor:t.grid, title:'MACD', titlefont:{size:10}, showticklabels:showMACD}
  };
}

/** 建立 / 更新圖 */
function redrawChart(){
  if(!KState.data || !KState.data.length) return;

  const theme = Themes[KState.theme];
  const d = sliceByRange(KState.data, KState.range);
  const x = d.map(r=>r.date), o=d.map(r=>r.open), h=d.map(r=>r.high), l=d.map(r=>r.low), c=d.map(r=>r.close);
  const v = d.map(r=>r.volume||0);

  const showRSI  = !!document.getElementById('chkRSI')?.checked;
  const showMACD = !!document.getElementById('chkMACD')?.checked;

  const traces = [];

  // 價格 K 線（主圖）
  traces.push({
    x, open:o, high:h, low:l, close:c, type:'candlestick', name:'Price', yaxis:'y'
  });

  // MA
  if($('#chkMA5')?.checked){  traces.push({x, y:MA(c,5),  type:'scatter', mode:'lines', name:'MA5',  line:{width:1.4, color:theme.ma5}, yaxis:'y'}); }
  if($('#chkMA20')?.checked){ traces.push({x, y:MA(c,20), type:'scatter', mode:'lines', name:'MA20', line:{width:1.4, color:theme.ma20}, yaxis:'y'}); }
  if($('#chkMA60')?.checked){ traces.push({x, y:MA(c,60), type:'scatter', mode:'lines', name:'MA60', line:{width:1.4, color:theme.ma60}, yaxis:'y'}); }

  // BB
  if($('#chkBB')?.checked){
    const bb=Bollinger(c,20,2);
    traces.push({x, y:bb.upper, type:'scatter', mode:'lines', name:'BB Upper', line:{width:1, dash:'dot', color:theme.bb}, yaxis:'y'});
    traces.push({x, y:bb.mid,   type:'scatter', mode:'lines', name:'BB Mid',   line:{width:1, dash:'dot', color:theme.bb}, yaxis:'y'});
    traces.push({x, y:bb.lower, type:'scatter', mode:'lines', name:'BB Lower', line:{width:1, dash:'dot', color:theme.bb}, yaxis:'y'});
  }

  // Volume（固定顯示）
  traces.push({x, y:v, type:'bar', name:'Volume', marker:{color:theme.vol}, yaxis:'y2'});

  // RSI（有勾才畫）
  if(showRSI){
    traces.push({x, y:RSI(c,14), type:'scatter', mode:'lines', name:'RSI(14)', line:{width:1.2, color:theme.rsi}, yaxis:'y3'});
    traces.push({x:[x[0],x[x.length-1]], y:[70,70], type:'scatter', mode:'lines', name:'', line:{width:1, dash:'dot', color:theme.grid}, yaxis:'y3', hoverinfo:'skip', showlegend:false});
    traces.push({x:[x[0],x[x.length-1]], y:[30,30], type:'scatter', mode:'lines', name:'', line:{width:1, dash:'dot', color:theme.grid}, yaxis:'y3', hoverinfo:'skip', showlegend:false});
    traces.push({x:[x[0],x[x.length-1]], y:[50,50], type:'scatter', mode:'lines', name:'', line:{width:.5, dash:'dot', color:theme.grid}, yaxis:'y3', hoverinfo:'skip', showlegend:false});
  }

  // MACD（有勾才畫）
  if(showMACD){
    const {macd, signal, hist} = MACD(c,12,26,9);
    traces.push({x, y:macd,   type:'scatter', mode:'lines', name:'MACD',   line:{width:1.2, color:theme.macd}, yaxis:'y4'});
    traces.push({x, y:signal, type:'scatter', mode:'lines', name:'Signal', line:{width:1,  color:theme.rsi},  yaxis:'y4'});
    traces.push({x, y:hist,   type:'bar',     name:'Hist',   marker:{color:theme.grid}, yaxis:'y4'});
  }

  const layout = getLayoutTheme({showRSI, showMACD});
  Plotly.react('kchart', traces, layout, {displayModeBar:true, responsive:true});
}

/** 載入後端日資料 → 依顆粒度轉換 → 畫圖 */
async function drawHistory(sym){
  const j = await callAPI('history',{symbol:sym});
  if(!j.ok || !j.data || !j.data.ohlc || !j.data.ohlc.length){
    toast('查無歷史資料，請先按「更新到最新日K」'); return;
  }
  // 確保日期升冪
  const arr = j.data.ohlc.slice().sort((a,b)=> a.date<b.date?-1:1);
  KState.rawDaily = arr.map(r=>({
    date:r.date, open:+r.open, high:+r.high, low:+r.low, close:+r.close, volume: (r.volume??0)|0
  }));
  // 預設顆粒度
  KState.data = resampleOHLC(KState.rawDaily, KState.tf);
  redrawChart();
}

/** UI 綁定 */
(function bindKControls(){
  // 顆粒度
  document.querySelectorAll('[data-k-tf]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('[data-k-tf]').forEach(b=>b.classList.remove('ring-2'));
      btn.classList.add('ring-2','ring-sky-500');
      KState.tf = btn.dataset.kTf;
      if(KState.rawDaily){ KState.data = resampleOHLC(KState.rawDaily, KState.tf); redrawChart(); }
    });
  });
  // 初始選取日K
  document.querySelector('[data-k-tf="D"]')?.classList.add('ring-2','ring-sky-500');

  // 區間
  document.querySelectorAll('[data-k-range]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('[data-k-range]').forEach(b=>b.classList.remove('ring-2'));
      btn.classList.add('ring-2','ring-emerald-500');
      KState.range = btn.dataset.kRange;
      redrawChart();
    });
  });
  document.querySelector('[data-k-range="ALL"]')?.classList.add('ring-2','ring-emerald-500');

  // 指標
  ['chkMA5','chkMA20','chkMA60','chkBB','chkRSI','chkMACD'].forEach(id=>{
    document.getElementById(id)?.addEventListener('change', redrawChart);
  });

  // 主題
  document.getElementById('btnTheme')?.addEventListener('click', ()=>{
    KState.theme = (KState.theme==='dark'?'light':'dark');
    // 視覺同步：整頁主色（不強制，僅調圖表）
    document.documentElement.style.colorScheme = KState.theme==='dark'?'dark':'light';
    redrawChart();
  });
})();

  /* ===== 預測區（固定欄位） ===== */
  function clearPredictArea(){
    setTxt('pred_method','—'); setTxt('pred_next','—');
    setTxt('pred_suggest','—'); setTxt('pred_reason','—');
    setTxt('pred_target','—'); setTxt('pred_target_conf','—');
    setTxt('signal_advice','—'); setTxt('signal_why','—'); setTxt('signal_days','—');
    setTxt('risk_var95','—'); setTxt('risk_atr','—'); setTxt('risk_kelly20','—');
    toast('');
  }
  function renderPredict(d){
    const method = d?.method || d?.algo || '—';
    const pred   = num(d?.next_close_pred);
    const last   = num(d?.last_close);
    const parts  = d?.components && typeof d.components==='object' ? d.components : null;

    // —— 建議：用預測與昨收的相對變化自動判斷（閾值可調）
    let advice = '—';
    let reason = 'RF/LR/Ridge 混合';
    if (pred!=null && last!=null && last!==0){
    const chg = (pred - last) / last;          // 相對漲跌
    const up = 0.008, dn = -0.008;             // 0.8% 閾值（你想更保守可改 1%）
    advice = chg > up ? '偏多' : (chg < dn ? '偏空' : '觀望');
    reason = `預測相對昨收 ${ (chg*100).toFixed(2) }%；${reason}`;
  }
    let confTxt = '—';
  if (parts){
    const vals = Object.values(parts).map(num).filter(v=>v!=null);
    if (vals.length >= 2 && pred!=null){
      const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
      const variance = vals.reduce((a,b)=>a+(b-mean)**2,0)/vals.length;
      const std = Math.sqrt(variance);
      // 將「分散 / 價格」映射到 0–100 分，數學係數可按口味微調
      const cv = std / Math.max(1, Math.abs(pred));   // 變異係數
      let conf = Math.max(0, 100 - Math.min(100, cv * 4000)); // 4000 是縮放係數
      confTxt = `${conf.toFixed(0)}%`;
    }
  }

  // —— 寫入畫面
  setTxt('pred_method', method);
  setTxt('pred_next',   pred!=null ? pred : '—');
  setTxt('pred_suggest', advice);
  setTxt('pred_reason',  reason);
  // 「信心」屬於目標價那一列，這裡不動；若你想把這個信心也顯示在目標價那行，可在 renderTarget 內備援套用。
  toast('');
}
function renderTarget(d){
  // 後端可能回這些鍵名
  const tech = num(d?.tech_target);
  const val  = num(d?.val_target);
  const sug  = num(d?.suggested_target);
  const last = num(d?.last_close);
  // —— 顯示的目標價：優先 suggested，其次 tech，再 val
  const target = (sug??tech??val);
  setTxt('pred_target', target!=null ? target : '—');

  // —— 信心：用「技術面 vs 估值面」的一致性估計（差距越小越有信心）
  // 若 tech/val 兩者皆有，用 |tech - val| 與基準（取 last 或 target）比；否則用「target 與 last」距離粗估。
  let confTxt = '—';
  if (tech!=null && val!=null){
    const base = (last!=null && last>0) ? last : Math.max(1, Math.abs(target||0));
    const gap  = Math.abs(tech - val) / base;                 // 差距占比
    let conf = Math.max(0, 100 - Math.min(100, gap * 120));   // 120 為縮放係數，可調
    confTxt = `${conf.toFixed(0)}%`;
  } else if (target!=null && last!=null && last>0){
    // 只有一個面：距離越小，信心越保守
    const dist = Math.abs(target - last) / last;
    let conf = Math.max(0, 100 - Math.min(100, dist * 200));  // 200 為縮放係數，可調
    confTxt = `${conf.toFixed(0)}%`;
  }

  setTxt('pred_target_conf', confTxt);
  toast('');
}
  function renderSignal(d){
  // trade_signal.py：bias / setup / summary / timeframe_days :contentReference[oaicite:5]{index=5}
    const advice = [d?.bias, d?.setup].filter(Boolean).join(' / ');
    setTxt('signal_advice', advice || '—');
    setTxt('signal_why',    d?.summary ?? (d?.reasons?.join('；') || '—'));
    setTxt('signal_days',   d?.timeframe_days ?? '—');
    toast('');
  }
  function renderRisk(d){
  // risk_engine.py：risk.var95_daily（報酬率，顯示%）、risk.atr14、plan.kelly_fraction_cap20pct :contentReference[oaicite:6]{index=6}
    const varDaily = d?.risk?.var95_daily;
    setTxt('risk_var95',  (varDaily!=null) ? (Math.round(varDaily*10000)/100 + '%') : '—');
    setTxt('risk_atr',    d?.risk?.atr14 ?? '—');
    const kelly = d?.plan?.kelly_fraction_cap20pct;
    setTxt('risk_kelly20', (kelly!=null) ? (Math.round(kelly*1000)/10 + '%') : '—');
    toast('');
  }

  /* ===== 按鈕事件 ===== */
  document.getElementById('btnQuote')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('quote_live', {symbol:sym});
      if(!j.ok) return uiShowQuoteError(j.error);
      renderQuote(j.data);
      if(!j.data?.ohlc?.length){ await drawHistory(sym); }
    }catch(e){ uiShowQuoteError(e.message); }
  });
  document.getElementById('btnInfo')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('info', {symbol:sym});
      if(!j.ok) return uiShowInfoError(j.error);
      renderInfo(j.data);
    }catch(e){ uiShowInfoError(e.message); }
  });
  document.getElementById('btnUpdate')?.addEventListener('click', async()=>{
    try{
      const sym = mustSymbol();
      const j = await callAPI('update_today', {symbol:sym});
      if(!j.ok) return uiShowPredError(j.error);
      await drawHistory(sym);
      toast('已回填並更新 K 線');
    }catch(e){ uiShowPredError(e.message); }
  });
  async function doPredict(){
    const sym = mustSymbol();
    busy('btnPredict',true); toast('計算中…');
    const j = await callAPI('predict_next', {symbol:sym});
    busy('btnPredict',false);
    if(!j.ok){ toast(j.error||'predict_failed'); return; }
    renderPredict(j.data);
  }
  async function doTarget(){
    const sym = mustSymbol();
    busy('btnTarget', true); toast('計算中…');
    const j = await callAPI('predict_target', {symbol:sym, horizon:40});
    busy('btnTarget', false);
    if(!j.ok){ toast(j.error||'predict_target_failed'); return; }
    renderTarget(j.data);
  }
  async function doSignal(){
    const sym = mustSymbol();
    busy('btnSignal', true); toast('分析中…');
    const j = await callAPI('signal', {symbol:sym});
    busy('btnSignal', false);
    if(!j.ok){ toast(j.error||'signal_failed'); return; }
    renderSignal(j.data);
  }

  async function doRisk(){
    const sym = mustSymbol();
    busy('btnRisk', true); toast('分析中…');
    const j = await callAPI('risk', {symbol:sym, horizon:20});
    busy('btnRisk', false);
    if(!j.ok){ toast(j.error||'predict_risk_failed'); return; }
    renderRisk(j.data);
  }
  document.getElementById('btnPredict')?.addEventListener('click', doPredict);
  document.getElementById('btnTarget') ?.addEventListener('click', doTarget);
  document.getElementById('btnSignal') ?.addEventListener('click', doSignal);
  document.getElementById('btnRisk')   ?.addEventListener('click', doRisk);

  /* ===== 登入 / 註冊 / 重設 ===== */
  function updateLoginUI(user){
    if(user){
      $('#loginUser').textContent = user.username;
      show($('#btnLogout'), true); show($('#btnLoginOpen'), false); show($('#loginMask'), false);
    }else{
      $('#loginUser').textContent = '';
      show($('#btnLogout'), false); show($('#btnLoginOpen'), true);
    }
  }
  $('#btnLoginOpen')?.addEventListener('click', ()=> show($('#loginMask'), true));
  $('#btnCloseLogin')?.addEventListener('click', ()=> show($('#loginMask'), false));
  $('#btnLogout')?.addEventListener('click', async()=>{ await fetch('auth.php?action=logout'); updateLoginUI(null); });

  $('#btnLogin')?.addEventListener('click', async()=>{
    const u=$('#lgUser').value.trim(), p=$('#lgPass').value.trim();
    const j = await callAuth('login',{username:u,password:p});
    if(!j.ok){ setTxt('lgMsg', j.error||'login_failed'); return; }
    setTxt('lgMsg',''); updateLoginUI(j.user);
  });
  $('#btnRegister')?.addEventListener('click', async()=>{
    const u=$('#lgUser').value.trim(), p=$('#lgPass').value.trim();
    const j = await callAuth('register',{username:u,password:p});
    setTxt('lgMsg', j.ok ? '註冊成功，請按登入' : (j.error||'register_failed'));
  });
  $('#btnForgot')?.addEventListener('click', ()=>{
    $('#fpEmail').value = $('#lgUser').value.trim(); $('#fpCode').value=''; $('#fpNew').value='';
    setTxt('fpMsg',''); show($('#fpMask'), true); show($('#loginMask'), false);
  });
  $('#btnFPClose')?.addEventListener('click', ()=>{ show($('#fpMask'), false); show($('#loginMask'), true); });
  $('#btnSendCode')?.addEventListener('click', async()=>{
    const email=$('#fpEmail').value.trim();
    const j = await callAuth('forgot_password',{email});
    setTxt('fpMsg', j.ok ? `驗證碼（測試用）：${j.code}` : (j.error||'failed'));
  });
  $('#btnResetPwd')?.addEventListener('click', async()=>{
    const email=$('#fpEmail').value.trim(), code=$('#fpCode').value.trim(), newp=$('#fpNew').value.trim();
    const j = await callAuth('reset_password',{email,code,new_password:newp});
    setTxt('fpMsg', j.ok ? '已重設，請回登入' : (j.error||'failed'));
  });

  /* ===== 開站自檢 ===== */
  (async()=>{
    try{
      const w = await fetch('auth.php?action=whoami').then(r=>r.json());
      updateLoginUI(w?.user||null);
      await fetch('api.php?action=diag').then(r=>r.json());
    }catch{}
  })();
  </script>
</body>
</html>
